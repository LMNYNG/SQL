SELECT HISTORY_ID, FLOOR(DAILY_FEE*COALESCE((100-DISCOUNT_RATE)/100,1)*(DATEDIFF(END_DATE,START_DATE)+1)) AS FEE
FROM  ( SELECT A.CAR_ID, CAR_TYPE, DAILY_FEE, HISTORY_ID,  START_DATE, END_DATE,
        CASE WHEN DATEDIFF(END_DATE,START_DATE)+1 >=90 THEN '90일 이상'
        WHEN DATEDIFF(END_DATE,START_DATE)+1 >= 30 THEN '30일 이상'
        WHEN DATEDIFF(END_DATE,START_DATE)+1 >= 7 THEN '7일 이상'
        ELSE '단기'
        END AS 'DURATION_TYPE'
        FROM CAR_RENTAL_COMPANY_CAR A JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY B ON A.CAR_ID=B.CAR_ID
        WHERE CAR_TYPE='트럭' ) A
        LEFT OUTER JOIN
        CAR_RENTAL_COMPANY_DISCOUNT_PLAN B ON A.DURATION_TYPE=B.DURATION_TYPE AND B.CAR_TYPE='트럭'
ORDER BY  FEE DESC, HISTORY_ID DESC
